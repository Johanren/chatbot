const { createBot, createProvider, createFlow, addKeyword, EVENTS, media, addAnswer } = require('@bot-whatsapp/bot');
const WebWhatsappProvider = require('@bot-whatsapp/provider/web-whatsapp');
const MockAdapter = require('@bot-whatsapp/database/mock');

const TIMEOUT_INACTIVIDAD = 10 * 60 * 1000; // 10 minutos
const sesiones = new Map();
const temporizadores = new Map();

const setEstadoUsuario = (user, estado) => {
    sesiones.set(user, estado);
    reiniciarTemporizador(user);
};

const getEstadoUsuario = (user) => sesiones.get(user);

const limpiarEstadoUsuario = (user) => {
    sesiones.delete(user);
    if (temporizadores.has(user)) {
        clearTimeout(temporizadores.get(user));
        temporizadores.delete(user);
    }
};

const reiniciarTemporizador = (user) => {
    if (temporizadores.has(user)) {
        clearTimeout(temporizadores.get(user));
    }
    const timer = setTimeout(async () => {
        if (sesiones.has(user)) {
            sesiones.get(user).sendMessage("‚è≥ Has estado inactivo por m√°s de 10 minutos. Se cerrar√° la sesi√≥n.");
            limpiarEstadoUsuario(user);
        }
    }, TIMEOUT_INACTIVIDAD);

    temporizadores.set(user, timer);
};

/*Flujo Principal*/

const flowPrincipalAsesor = addKeyword(EVENTS.WELCOME)
    .addAction(async (ctx, { gotoFlow }) => {
        const estado = getEstadoUsuario(ctx.from);

        // Si el usuario est√° esperando un asesor, bloquea el flujo principal
        if (estado?.esperandoAsesor) {
            console.log("üîí Actualmente est√°s esperando a un asesor. No se ejecutar√° el flujo principal.");
            return;  // No hace nada, evitando el flujo
        }

        // Si no est√° esperando un asesor, continuar con el flujo principal
        return gotoFlow(flowPrincipal);
    });



const flowPrincipal = addKeyword(EVENTS.WELCOME)
    .addAnswer("üëã ¬°Hola! Bienvenido al asistente virtual de *Jordel Ingenier√≠a SAS, FiberNet*.", {}, async (ctx, { gotoFlow, flowDynamic }) => {
        return gotoFlow(flowMenuPrincipal);
    });

const flowMenuPrincipal = addKeyword(EVENTS.ACTION)
    .addAnswer([
        "üëá *Seleccione una opci√≥n:*",
        "1Ô∏è‚É£ Consulta de Servicio",
        "2Ô∏è‚É£ Facturaci√≥n y Pagos",
        "3Ô∏è‚É£ Planes y Promociones",
        "4Ô∏è‚É£ Soporte T√©cnico Avanzado",
        "5Ô∏è‚É£ Consulta Personalizada",
        "6Ô∏è‚É£ Asistencia en Tiempo Real",
        "7Ô∏è‚É£ Comentarios y Sugerencias",
        "8Ô∏è‚É£ Informaci√≥n General",
        "‚úñÔ∏è Escribe *cerrar sesi√≥n* para salir.",
        "*Escribe el n√∫mero de la opci√≥n que deseas.*"
    ], { capture: true }, async (ctx, { flowDynamic, gotoFlow }) => {
        setEstadoUsuario(ctx.from, { menu: "principal", sendMessage: flowDynamic });
        const seleccion = ctx.body.trim();
        if (seleccion === "Cerrar sesi√≥n") return gotoFlow(flowCerrarSesion);
        switch (seleccion) {
            case "1": return gotoFlow(flowConsultaServicio);
            case "2": return gotoFlow(flowFacturacionPagos);
            case "3": return gotoFlow(flowPlanesPromociones);
            case "4": return gotoFlow(flowSoporteTecnico);
            case "5": return gotoFlow(flowConsultaPersonalizada);
            case "6": return gotoFlow(flowAsistenciaTiendoReal);
            case "7": return gotoFlow(flowComentarioSugerencia);
            case "8": return gotoFlow(flowInformacionGeneral);
            default: return flowDynamic("‚ö†Ô∏è Opci√≥n no v√°lida. Intente nuevamente.") + gotoFlow(flowMenuPrincipal);
        }
    });

/*Cierre Sesion*/

const flowCerrarSesion = addKeyword("cerrar sesi√≥n")
    .addAnswer("üîí ¬øSeguro que quieres cerrar sesi√≥n? Escribe *s√≠* o *no*.",
        { capture: true }, async (ctx, { flowDynamic, gotoFlow }) => {
            if (ctx.body.trim().toLowerCase() === "si"  || ctx.body.trim().toLowerCase() === "Si") {
                limpiarEstadoUsuario(ctx.from);
                return flowDynamic("‚úÖ Has cerrado sesi√≥n. Escribe *hola* para volver a activarlo.");
            }
            flowDynamic("üîô Regresando al men√∫ principal...");
            await new Promise(resolve => setTimeout(resolve, 1000)); // Espera 1 segundo antes de ir al flujo
            return gotoFlow(flowMenuPrincipal) 
        });

const flowVolverMenuPrincipal = addKeyword(["9"])
    .addAnswer("üîô Regresando al men√∫ principal...", {}, async (ctx, { flowDynamic, gotoFlow }) => {
        await new Promise(resolve => setTimeout(resolve, 1000)); // Espera 1 segundo antes de ir al flujo
        return gotoFlow(flowMenuPrincipal);
    });

const flowCerrarConversacion = addKeyword(["0"])
    .addAnswer("‚úÖ *Conversaci√≥n cerrada.*", {}, async (ctx, { flowDynamic, gotoFlow }) => {
        await new Promise(resolve => setTimeout(resolve, 1000)); // Espera 1 segundo antes de ir al flujo
        return gotoFlow(flowMenuPrincipal);
    });


/*Sub Menus*/

const flowConsultaServicio = addKeyword(EVENTS.ACTION)
    .addAnswer([
        "üëá *Seleccione una opci√≥n:*",
        "1Ô∏è‚É£üì° Estado de mi conexi√≥n",
        "2Ô∏è‚É£üîß Problemas t√©cnicos",
        "3Ô∏è‚É£üìÖ Mantenimiento programado",
        "9Ô∏è‚É£ Volver al men√∫ principal"
    ], { capture: true }, async (ctx, { flowDynamic, gotoFlow }) => {
        const seleccion = ctx.body.trim();
        const respuestas = {
            "1": "üì° Tu conexi√≥n est√° funcionando correctamente.",
            "2": "üîß Puedes contactar a soporte t√©cnico al 123-456-7890.",
            "3": "üìÖ No hay mantenimientos programados en este momento.",
        };
        if (seleccion === "9") return gotoFlow(flowVolverMenuPrincipal);
        await flowDynamic("‚è≥ Por favor, espera un momento mientras procesamos tu solicitud...");
        await new Promise(resolve => setTimeout(resolve, 20000)); // 20 segundos de espera
        await flowDynamic(respuestas[seleccion] || "‚ö†Ô∏è Opci√≥n no v√°lida. Intente nuevamente." + gotoFlow(flowConsultaServicio));
        return;
    });

const flowFacturacionPagos = addKeyword(EVENTS.ACTION)
    .addAnswer([
        "üëá *Facturaci√≥n y Pagos:*",
        "1Ô∏è‚É£üí∞ Consultar saldo",
        "2Ô∏è‚É£üí≥ Realizar un pago",
        "3Ô∏è‚É£üìú Historial de facturaci√≥n",
        "9Ô∏è‚É£ Volver al men√∫ principal"
    ], { capture: true }, async (ctx, { flowDynamic, gotoFlow }) => {
        const seleccion = ctx.body.trim();
        const respuestas = {
            "1": "üí∞ Tu saldo es de $50,000 COP.",
            "2": "üí≥ Puedes realizar un pago en nuestra plataforma.",
            "3": "üìú Aqu√≠ est√° tu historial de pagos.",
        };
        if (seleccion === "9") return gotoFlow(flowVolverMenuPrincipal);
        await flowDynamic("‚è≥ Por favor, espera un momento mientras procesamos tu solicitud...");
        await new Promise(resolve => setTimeout(resolve, 20000)); // 20 segundos de espera
        await flowDynamic(respuestas[seleccion] || "‚ö†Ô∏è Opci√≥n no v√°lida. Intente nuevamente." + gotoFlow(flowFacturacionPagos));
        return;
    });

const flowPlanesPromociones = addKeyword(EVENTS.ACTION)
    .addAnswer([
        "üëá *Planes y Promociones:*",
        "1Ô∏è‚É£üìÑ Explorar planes",
        "2Ô∏è‚É£üî• Promociones actuales",
        "3Ô∏è‚É£üîÑ Cambio de plan",
        "9Ô∏è‚É£ Volver al men√∫ principal"
    ], { capture: true }, async (ctx, { flowDynamic, gotoFlow }) => {
        const seleccion = ctx.body.trim();
        const respuestas = {
            "1": "üìÑ Planes de hasta 1 Gbps disponibles.",
            "2": "üî• 10% de descuento en nuevos suscriptores.",
            "3": "üîÑ Contacta a un asesor para cambiar de plan."
        };
        if (seleccion === "9") return gotoFlow(flowVolverMenuPrincipal);
        await flowDynamic("‚è≥ Por favor, espera un momento mientras procesamos tu solicitud...");
        await new Promise(resolve => setTimeout(resolve, 20000)); // 20 segundos de espera
        await flowDynamic(respuestas[seleccion] || "‚ö†Ô∏è Opci√≥n no v√°lida. Intente nuevamente." + gotoFlow(flowPlanesPromociones));
        return;
    });

const flowSoporteTecnico = addKeyword(EVENTS.ACTION)
    .addAnswer([
        "üëá *Soporte T√©cnico Avanzado:*",
        "1Ô∏è‚É£üîç Diagn√≥stico de red",
        "2Ô∏è‚É£‚öôÔ∏è Configuraci√≥n avanzada",
        "3Ô∏è‚É£üìû Contactar a un t√©cnico",
        "9Ô∏è‚É£ Volver al men√∫ principal"
    ], { capture: true }, async (ctx, { flowDynamic, gotoFlow }) => {
        const seleccion = ctx.body.trim();
        const respuestas = {
            "1": "üîç Realiza un diagn√≥stico de red en nuestra app.",
            "2": "‚öôÔ∏è Consulta nuestra gu√≠a de configuraci√≥n avanzada.",
            "3": "üìû Llama al 123-456-7890 para soporte t√©cnico."
        };
        if (seleccion === "9") return gotoFlow(flowVolverMenuPrincipal);
        await flowDynamic("‚è≥ Por favor, espera un momento mientras procesamos tu solicitud...");
        await new Promise(resolve => setTimeout(resolve, 20000)); // 20 segundos de espera
        await flowDynamic(respuestas[seleccion] || "‚ö†Ô∏è Opci√≥n no v√°lida. Intente nuevamente." + gotoFlow(flowSoporteTecnico));
        return;
    });

const flowConsultaPersonalizada = addKeyword(EVENTS.ACTION)
    .addAnswer([
        "üëá *Consulta Personalizada:*",
        "1Ô∏è‚É£ Asistente inteligente",
        "2Ô∏è‚É£ Sugerencias basadas en historial",
        "9Ô∏è‚É£ Volver al men√∫ principal"
    ], { capture: true }, async (ctx, { flowDynamic, gotoFlow }) => {
        const seleccion = ctx.body.trim();
        const respuestas = {
            "1": " Describe tu problema o consulta y recibir√°s una respuesta personalizada",
            "2": " Si has interactuado antes, puedo ofrecerte soluciones basadas en tus consultas pasadas."
        };
        if (seleccion === "9") return gotoFlow(flowVolverMenuPrincipal);
        await flowDynamic("‚è≥ Por favor, espera un momento mientras procesamos tu solicitud...");
        await new Promise(resolve => setTimeout(resolve, 20000)); // 20 segundos de espera
        await flowDynamic(respuestas[seleccion] || "‚ö†Ô∏è Opci√≥n no v√°lida. Intente nuevamente." + gotoFlow(flowSoporteTecnico));
        return;
    });

const flowAsistenciaTiendoReal = addKeyword(EVENTS.ACTION)
    .addAnswer([
        "üëá *Asistencia en Tiempo Real:*",
        "1Ô∏è‚É£ Hablar con un agente",
        "2Ô∏è‚É£ Programar una llamada",
        "9Ô∏è‚É£ Volver al men√∫ principal"
    ], { capture: true }, async (ctx, { flowDynamic, gotoFlow }) => {
        const seleccion = ctx.body.trim();

        if (seleccion === "9") return gotoFlow(flowVolverMenuPrincipal);

        // Respuestas seg√∫n opci√≥n seleccionada
        if (seleccion === "1") {
            await flowDynamic("üîÑ Con√©ctate con un representante humano para asistencia directa.");
            return gotoFlow(flowChatAsesor);
        }

        if (seleccion === "2") {
            await flowDynamic("üìû Si prefieres que te contacten, d√©janos tu informaci√≥n.");
            return gotoFlow(flowChatAsesor);
        }

        // Opci√≥n no v√°lida
        await flowDynamic("‚ö†Ô∏è Opci√≥n no v√°lida. Intente nuevamente.");
        return gotoFlow(flowSoporteTecnico);
    });


const flowComentarioSugerencia = addKeyword(EVENTS.ACTION)
    .addAnswer([
        "üëá *Comentarios y Sugerencias:*",
        "1Ô∏è‚É£ Dejar una opini√≥n",
        "2Ô∏è‚É£ Participar en encuestas",
        "9Ô∏è‚É£ Volver al men√∫ principal"
    ], { capture: true }, async (ctx, { flowDynamic, gotoFlow }) => {
        const seleccion = ctx.body.trim();
        const respuestas = {
            "1": " Comparte tu experiencia y sugerencias para mejorar.",
            "2": " Ay√∫danos a mejorar nuestros servicios respondiendo a breves encuestas"
        };
        if (seleccion === "9") return gotoFlow(flowVolverMenuPrincipal);
        await flowDynamic("‚è≥ Por favor, espera un momento mientras procesamos tu solicitud...");
        await new Promise(resolve => setTimeout(resolve, 20000)); // 20 segundos de espera
        await flowDynamic(respuestas[seleccion] || "‚ö†Ô∏è Opci√≥n no v√°lida. Intente nuevamente." + gotoFlow(flowSoporteTecnico));
        return;
    });

const flowInformacionGeneral = addKeyword(EVENTS.ACTION)
    .addAnswer([
        "üëá *Informaci√≥n General:*",
        "1Ô∏è‚É£ Preguntas frecuentes",
        "2Ô∏è‚É£ Pol√≠ticas de uso y privacidad",
        "9Ô∏è‚É£ Volver al men√∫ principal"
    ], { capture: true }, async (ctx, { flowDynamic, gotoFlow }) => {
        const seleccion = ctx.body.trim();
        const respuestas = {
            "1": " Encuentra respuestas a las preguntas m√°s comunes.",
            "2": " Consulta nuestras pol√≠ticas y t√©rminos."
        };
        if (seleccion === "9") return gotoFlow(flowVolverMenuPrincipal);
        await flowDynamic("‚è≥ Por favor, espera un momento mientras procesamos tu solicitud...");
        await new Promise(resolve => setTimeout(resolve, 20000)); // 20 segundos de espera
        await flowDynamic(respuestas[seleccion] || "‚ö†Ô∏è Opci√≥n no v√°lida. Intente nuevamente." + gotoFlow(flowSoporteTecnico));
        return;
    });

/*Hablar con un accesor*/

// Inicializar el objeto global si no existe
if (!global.tiempoInactividad) {
    global.tiempoInactividad = {};
}

const flowChatAsesor = addKeyword(EVENTS.ACTION)
    .addAction(async (ctx, { flowDynamic, gotoFlow }) => {
        const usuarioID = ctx.from;

        // Marcar como esperando asesor
        setEstadoUsuario(usuarioID, { esperandoAsesor: true });

        if (ctx.body.trim() === "0") {
            limpiarEstadoUsuario(usuarioID);
            return gotoFlow(flowMenuPrincipal); // Regresar al flujo principal
        }

        // Mensaje despu√©s de 2 segundos
        setTimeout(async () => {
            await flowDynamic("üëá *En un momento, uno de nuestros asesores se comunicar√° contigo.*");
        }, 2000);

        // Configurar recordatorio de inactividad despu√©s de 5 minutos (300,000 ms)
        if (global.tiempoInactividad[usuarioID]) {
            clearTimeout(global.tiempoInactividad[usuarioID]); // Limpiar cualquier temporizador previo
        }

        global.tiempoInactividad[usuarioID] = setTimeout(async () => {
            const estado = getEstadoUsuario(usuarioID);
            if (estado?.esperandoAsesor) {
                await flowDynamic("‚è≥ Parece que has estado inactivo. Si deseas cerrar la conversaci√≥n, responde con *0Ô∏è‚É£*.");
            }
        }, 300000); // 5 minutos en milisegundos
    });


const main = async () => {
    const adapterDB = new MockAdapter();
    const adapterFlow = createFlow([flowPrincipalAsesor, flowPrincipal, flowMenuPrincipal, flowConsultaServicio, flowFacturacionPagos, flowPlanesPromociones, flowSoporteTecnico, flowConsultaPersonalizada, flowAsistenciaTiendoReal, flowComentarioSugerencia, flowInformacionGeneral, flowCerrarSesion, flowVolverMenuPrincipal, flowChatAsesor, flowCerrarConversacion]);
    const adapterProvider = createProvider(WebWhatsappProvider);
    createBot({ flow: adapterFlow, provider: adapterProvider, database: adapterDB });

    console.log("ü§ñ Bot en ejecuci√≥n...");
};

main();
